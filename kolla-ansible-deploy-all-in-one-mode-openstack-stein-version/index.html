<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title> - kolla-ansible 部署 all-in-one 模式 OpenStack stein版</title>

      
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;rss.xml">
      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">zongwu&#x27;s blog</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;about">
                            About
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;rss.xml">
                            RSS
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;blog.zongwu233.com">zongwu&#x27;s blog</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;rss.xml">
                                    RSS
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#qian-qi-zhun-bei" class="toc-link">前期准备</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#ji-qi-pei-zhi" class="toc-link">机器配置</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#xi-tong-huan-jing-pei-zhi" class="toc-link">系统环境配置</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#ying-pan-de-kuai-cun-chu-pei-zhi" class="toc-link">硬盘的块存储配置</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#an-zhuang" class="toc-link">安装</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#an-zhuang-docker" class="toc-link">安装 docker</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#an-zhuang-qi-ta-yi-lai" class="toc-link">安装其他依赖</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#an-zhuang-ansible" class="toc-link">安装ansible</a>
                        </li>
                        
                        <li>
                            <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#an-zhuang-kolla-ansible" class="toc-link">安装 kolla-ansible</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#bu-shu" class="toc-link">部署</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.zongwu233.com/kolla-ansible-deploy-all-in-one-mode-openstack-stein-version/#guan-li" class="toc-link">管理</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;kolla-ansible-deploy-all-in-one-mode-openstack-stein-version&#x2F;">kolla-ansible 部署 all-in-one 模式 OpenStack stein版</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2020-08-15</span>
            
        </div>
    </header>

    <div class="post-content">
      <h2 id="qian-qi-zhun-bei">前期准备</h2>
<h3 id="ji-qi-pei-zhi">机器配置</h3>
<p>20Core  50G Memory  3.6 T Storage</p>
<p>双网卡，enp3s0 局域网静态ip配置，网卡作为管理后台地址，enp4s0 不要配置静态ip，可使用dhcp模式分配ip，用于后续OpenStack的虚拟机上网网卡。</p>
<p>注意两个网卡不要处于同一网段，采用 enp4s0 所在的网关作为本机的默认网关。</p>
<h3 id="xi-tong-huan-jing-pei-zhi">系统环境配置</h3>
<p>系统为 centOS 7.8  python 2.7.5</p>
<p>关闭防火墙/NetworkManager/SElinux</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">systemctl stop NetworkManager firewalld

systemctl disable NetworkManager firewalld

sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/&quot; /etc/selinux/config

setenforce 0

</span></pre><h3 id="ying-pan-de-kuai-cun-chu-pei-zhi">硬盘的块存储配置</h3>
<p>这台机器的硬盘主要挂载在 /home 下</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">cd /home
truncate -s 2000G disk.img
</span></pre>
<p>这里创建了一个大小为2T的文件。采用下面这种方式创建大文件的速度太慢：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">dd if=/dev/zero of=./disk.img count=4096 bs=512MB 
</span></pre>
<p>创建文件之后，将磁盘文件虚拟成块设备</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">losetup -f

losetup /dev/loop0 disk.img
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#将物理磁盘初始化为物理卷PV
pvcreate /dev/loop0
#创建卷组 cinder-volumes，将PV加入到VG中
vgcreate cinder-volumes /dev/loop0
</span></pre><h2 id="an-zhuang">安装</h2>
<h3 id="an-zhuang-docker">安装 docker</h3>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">curl -sSL https://get.docker.io | bash
</span></pre>
<p>配置共享</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">vim /etc/systemd/system/docker.service.d/kolla.conf

[Service]
MountFlags=shared　　
ExecStart=
ExecStart=/usr/bin/dockerd --log-opt max-file=5 --log-opt max-size=50m

</span></pre>
<p>配置加速</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json &lt;&lt;-&#39;EOF&#39;
{
  &quot;registry-mirrors&quot;: [&quot;https://******.mirror.aliyuncs.com&quot;]
}
EOF

sudo systemctl daemon-reload
sudo systemctl restart docker

</span></pre>
<p><code>registry-mirrors</code> 地址可以在阿里云镜像管理自行申请。</p>
<h3 id="an-zhuang-qi-ta-yi-lai">安装其他依赖</h3>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">yum install git
yum install -y epel-release  
yum install -y python-pip 
mkdir .pip
# 更改pip软件包源
tee /root/.pip/pip.conf &lt;&lt; &#39;EOF&#39;
[global]
index-url = https://pypi.tuna.tsinghua.edu.cn/simple
EOF
pip install -U pip
</span></pre><h3 id="an-zhuang-ansible">安装ansible</h3>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pip install ansible
</span></pre><h3 id="an-zhuang-kolla-ansible">安装 kolla-ansible</h3>
<p><strong>这里要特别注意，不要按照官方文档说明，而是按照下面的操作，否则后面部署的时候，会出现各种错误导致部署失败</strong></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">git clone https://github.com/openstack/kolla -b stable/stein
git clone https://github.com/openstack/kolla-ansible -b stable/stein
pip install -r kolla/requirements.txt
pip install -r kolla-ansible/requirements.txt
cd kolla-ansible &amp;&amp;  python setup.py install
</span></pre>
<p>这里是采用指定源码分支，安装 kolla-ansible。</p>
<p>当前目录是 kolla-ansible ，执行</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">mkdir /etc/kolla &amp;&amp; cp etc/kolla/* /etc/kolla
cp ansible/inventory/* ~
</span></pre>
<p>生成OpenStack各服务的密码文件</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">kolla-genpwd
#修改openstack管理后台的登陆密码
vim /etc/kolla/passwords.yml
keystone_admin_password 123456
</span></pre>
<p>编辑 kolla的配置文件</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">vim /etc/kolla/globals.yml
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">
kolla_base_distro: &quot;centos&quot;

#官方建议采用 source 更稳定而不是binary
kolla_install_type: &quot;source&quot;
# 版本
openstack_release: &quot;stein&quot;
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;"># Kolla options

#这里的ip 是 network_interface 网卡的ip 如果不配置，导致数据库（高可用模式）无法正常启动
kolla_internal_vip_address: &quot;10.0.0.104&quot;

#单机模式，关闭高可用
enable_haproxy: &quot;no&quot;

# Neutron - Networking Options
network_interface: &quot;enp3s0&quot;
neutron_external_interface: &quot;enp4s0&quot;

# TLS options
kolla_enable_tls_internal: &quot;no&quot;
kolla_enable_tls_external: &quot;no&quot;

# 使用cinder存储
enable_cinder: &quot;yes&quot;
enable_glance: &quot;yes&quot;
enable_magnum: &quot;yes&quot;
enable_heat: &quot;yes&quot;

# 如果使用lvm，需先创建cinder-volumes的卷组，上面已经创建过
enable_cinder_backend_lvm: &quot;yes&quot;
# 默认是kvm ，但是实际部署发现不生效，系统自动采用了 qemu
nova_compute_virt_type: &quot;kvm&quot;
</span></pre>
<p>配置修改完成，可以拉取所有镜像，当前工作目录是 <code>~</code></p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">#提前拉取依赖的镜像
kolla-ansible -i ./all-in-one pull
</span></pre>
<p>这个过程会很久，看网络情况。</p>
<h2 id="bu-shu">部署</h2>
<p>执行openstack部署需要的引导服务、部署前检查</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;"># 引导服务
kolla-ansible -i ./all-in-one bootstrap-servers 
#安装前的检查
kolla-ansible -i ./all-in-one prechecks
</span></pre>
<p>结果都ok，可以进行部署</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">kolla-ansible -i ./all-in-one deploy
</span></pre>
<p>这一步也会很久。部署完成之后，</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">kolla-ansible -i ./all-in-one  post-deploy
</span></pre>
<p>这一步会生成 <code>/etc/kolla/admin-openrc.sh</code> 文件。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">cat /etc/kolla/admin-openrc.sh　

export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=admin
export OS_TENANT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=123456
export OS_AUTH_URL=http://10.0.0.104:35357/v3
export OS_INTERFACE=internal
export OS_IDENTITY_API_VERSION=3
export OS_REGION_NAME=RegionOne
export OS_AUTH_PLUGIN=password
</span></pre>
<p>安装 openstackclient ，可以在控制台执行openstack命令</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">pip install python-openstackclient
</span></pre><h2 id="guan-li">管理</h2>
<p>在浏览器打开 http://10.0.0.104 输入 admin 账号密码即可进入。</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;tags&#x2F;openstack&#x2F;">#OpenStack</a>
                    
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;tags&#x2F;kolla-ansible&#x2F;">#kolla-ansible</a>
                    
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;tags&#x2F;ansible&#x2F;">#ansible</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;the-starter&#x2F;">‹ The Starter</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;openstack-management&#x2F;">OpenStack 管理 ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;even.js" ></script>
      
      <!--  add cnzz trace code  -->
      
          <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");document.write(unescape("%3Cspan style='display:none;' id='cnzz_stat_icon_1273937782'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1273937782' type='text/javascript'%3E%3C/script%3E"));</script>
      
    </body>

</html>
