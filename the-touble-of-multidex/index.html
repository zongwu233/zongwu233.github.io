<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title> - 其实你不知道MultiDex到底有多坑</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">zongwu&#x27;s blog</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;about">
                            About
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;rss.xml">
                            RSS
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;blog.zongwu233.com">zongwu&#x27;s blog</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;rss.xml">
                                    RSS
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    



<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;the-touble-of-multidex&#x2F;">其实你不知道MultiDex到底有多坑</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2015-09-26</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>愉快地写着Android代码的总悟君往工程里引入了一个默默无闻的jar然后Run了一下， 经过漫长的等待AndroidStudio构建失败了。</p>
<span id="continue-reading"></span>
<p>于是总悟君带着疑惑查看错误信息。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#d08770;">UNEXPECTED TOP</span><span style="color:#c0c5ce;">-</span><span style="color:#d08770;">LEVEL EXCEPTION</span><span style="color:#c0c5ce;">: java.lang.</span><span style="color:#ebcb8b;">IllegalArgumentException</span><span style="color:#c0c5ce;">: method </span><span style="color:#d08770;">ID</span><span style="color:#c0c5ce;"> not in [</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0xffff</span><span style="color:#c0c5ce;">]: </span><span style="color:#d08770;">65536</span><span style="color:#c0c5ce;"> 
	at com.android.dx.merge.</span><span style="color:#ebcb8b;">DexMerger$6</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">updateIndex</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">DexMerger</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">501</span><span style="color:#c0c5ce;">) 
	at com.android.dx.merge.</span><span style="color:#ebcb8b;">DexMerger$IdMerger</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">mergeSorted</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">DexMerger</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">276</span><span style="color:#c0c5ce;">) 
	at com.android.dx.merge.</span><span style="color:#ebcb8b;">DexMerger</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">mergeMethodIds</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">DexMerger</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">490</span><span style="color:#c0c5ce;">) 
	at com.android.dx.merge.</span><span style="color:#ebcb8b;">DexMerger</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">mergeDexes</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">DexMerger</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">167</span><span style="color:#c0c5ce;">) 
	at com.android.dx.merge.</span><span style="color:#ebcb8b;">DexMerger</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">merge</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">DexMerger</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">188</span><span style="color:#c0c5ce;">) 
	at com.android.dx.command.dexer.</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">mergeLibraryDexBuffers</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">439</span><span style="color:#c0c5ce;">) 
	at com.android.dx.command.dexer.</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">runMonoDex</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">287</span><span style="color:#c0c5ce;">) 
	at com.android.dx.command.dexer.</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">run</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">230</span><span style="color:#c0c5ce;">) 
	at com.android.dx.command.dexer.</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">main</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">199</span><span style="color:#c0c5ce;">) 
	at com.android.dx.command.</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">main</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Main</span><span style="color:#c0c5ce;">.java:</span><span style="color:#d08770;">103</span><span style="color:#c0c5ce;">):</span><span style="color:#ebcb8b;">Derp</span><span style="color:#c0c5ce;">:dexDerpDebug </span><span style="color:#d08770;">FAILED
</span></code></pre>
<p>看起来是：在试图将 classes和jar塞进一个Dex文件的过程中产生了错误。</p>
<p>早期的Dex文件保存所有classes的方法个数的范围在0~65535之间。业务一直在增长，总悟君写(copy)的代码越来越长引入的库越来越多，超过这个范围只是时间问题。</p>
<p>怎么解？？太阳底下木有新鲜事，淡定先google一发，找找已经踩过坑的小伙伴。</p>
<p>StackOverflow 的网友们对该问题表示情绪稳定，谈笑间抛出multiDex。</p>
<p>这是Android官网对当初的短视行为给出的<a href="https://developer.android.com/tools/building/multidex.html">补丁方案</a>。文档说，Dalvik Executable (DEX)文件的总方法数限制在65536以内，其中包括Android framwork method， lib method (后来总悟君发现仅仅是Android 自己的框架的方法就已经占用了1w多)，还有你的 code method ，所以请使用MultiDex。 对于5.0以下版本，请使用multidex support library (这个是我们的补丁包！build tools 请升级到21)。而5.0及以上版本，由于ART模式的存在，app第一次安装之后会进行一次预编译(pre-compilation) ，如果这时候发现了classes(..N).dex文件的存在就会将他们最终合成为一个.oat的文件，嗯看起来很厉害的样子。</p>
<p>同时Google建议review代码的直接或者间接依赖，尽可能减少依赖库，设置proguard参数进一步优化去除无用的代码。嗯，这两个实施起来倒是很简单，但是治标不治本，躲得过初一躲不过十五。</p>
<p>在Google给出这个解决方案之前，他们的开发人员先给了一个~~简陋~~简易版本的multiDex具体参看这里。（怀疑后来的官方解决方案就有这家伙参与）。简单地说就是：</p>
<ol>
<li>
<p>先把你的app 的class 拆分成主次两个dex。</p>
</li>
<li>
<p>你的程序运行起来后，自己把第二个dex给load进来。</p>
</li>
</ol>
<p>看就这么简单！而且这就是个动态加载模块的框架！ 然而总悟君早已看穿Dalvik VM 这种动态加载dex 的能力归根结底还是因为java 的classloader类加载机制。沿着这条道走，Android模块动态化加载，包括dex级别和apk级别的动态化加载，各种玩法层出不穷。参见这里<a href="https://github.com/singwhatiwanna/dynamic-load-apk">1</a><a href="https://github.com/houkx/android-pluginmgr">2</a><a href="https://github.com/mmin18/AndroidDynamicLoader">3</a><a href="https://github.com/bunnyblue/OpenAtlas">4</a><a href="http://www.apkplug.com/">5</a><a href="https://github.com/Qihoo360/DroidPlugin">6</a>。</p>
<h2 id="di-yi-hui-he-tian-zhen-de-guan-fang-bu-ding-fang-an">第一回合 天真的官方补丁方案</h2>
<p>还是先解决打包问题，回头再研究那些高深的动态化加载技术。~~偷懒一下咯~~考虑到投入产出比，决定使用Google官方的multiDex解决。(Google的补丁方案啊，不会再有坑了吧？后面才发现还是太天真)
该方案有两步：</p>
<ol>
<li>修改gradle脚本来产生多dex。</li>
<li>修改manifest 使用MulitDexApplication。</li>
</ol>
<p>步骤1在gradle脚本里写上：</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">android {
	compileSdkVersion </span><span style="color:#d08770;">21</span><span style="color:#c0c5ce;">
	buildToolsVersion &quot;</span><span style="color:#a3be8c;">21.1.0</span><span style="color:#c0c5ce;">&quot;

	defaultConfig {
		...
		minSdkVersion </span><span style="color:#d08770;">14</span><span style="color:#c0c5ce;">
		targetSdkVersion </span><span style="color:#d08770;">21
		</span><span style="color:#c0c5ce;">...

		</span><span style="color:#65737e;">// Enabling multidex support.
</span><span style="color:#c0c5ce;">		multiDexEnabled </span><span style="color:#d08770;">true
	</span><span style="color:#c0c5ce;">}
	...
}

dependencies {
compile &#39;</span><span style="color:#a3be8c;">com.android.support:multidex:1.0.0</span><span style="color:#c0c5ce;">&#39;
}
</span></code></pre>
<p>步骤2manifest声明修改</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&lt;?xml version=&quot;</span><span style="color:#a3be8c;">1.0</span><span style="color:#c0c5ce;">&quot; encoding=&quot;</span><span style="color:#a3be8c;">utf-8</span><span style="color:#c0c5ce;">&quot;?&gt;
&lt;manifest </span><span style="color:#d08770;">xmlns</span><span style="color:#c0c5ce;">:android=&quot;</span><span style="color:#a3be8c;">http://schemas.android.com/apk/res/android</span><span style="color:#c0c5ce;">&quot;
package=&quot;</span><span style="color:#a3be8c;">com.example.android.multidex.myapplication</span><span style="color:#c0c5ce;">&quot;&gt;
&lt;application
...
</span><span style="color:#d08770;">android</span><span style="color:#c0c5ce;">:name=&quot;</span><span style="color:#a3be8c;">android.support.multidex.MultiDexApplication</span><span style="color:#c0c5ce;">&quot;&gt;
...
&lt;/</span><span style="color:#96b5b4;">application&gt;
&lt;</span><span style="color:#c0c5ce;">/manifest&gt;
</span></code></pre>
<p>如果有自己的Application，继承MulitDexApplication。如果当前代码已经继承自其它Application没办法修改那也行，就重写 Application的attachBaseContext()这个方法。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#b48ead;">protected</span><span style="color:#c0c5ce;"> void </span><span style="color:#bf616a;">attachBaseContext</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Context</span><span style="color:#c0c5ce;"> base) {
	</span><span style="color:#bf616a;">super</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">attachBaseContext</span><span style="color:#c0c5ce;">(base);
	</span><span style="color:#ebcb8b;">MultiDex</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">install</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">);     

} 
</span></code></pre>
<p>run一下，可以了！但是dex过程好像变慢了。。。</p>
<p>文档还写明了multiDex support lib 的局限。瞄一下是什么：</p>
<ol>
<li>在应用安装到手机上的时候dex文件的安装是复杂的(complex)有可能会因为第二个dex文件太大导致ANR。请用proguard优化你的代码。<del>呵呵</del></li>
<li>使用了mulitDex的App有可能在4.0(api level 14)以前的机器上无法启动，因为Dalvik linearAlloc bug(Issue <a href="https://code.google.com/p/android/issues/detail?id=22586">22586</a>)  。请多多测试自祈多福。用proguard优化你的代码将减少该bug几率。<del>呵呵</del></li>
<li>使用了mulitDex的App在runtime期间有可能因为Dalvik linearAlloc limit (Issue <a href="https://code.google.com/p/android/issues/detail?id=78035">78035</a>)  Crash。该内存分配限制在 4.0版本被增大，但是5.0以下的机器上的Apps依然会存在这个限制。</li>
<li>主dex被dalvik虚拟机执行时候，哪些类必须在主dex文件里面这个问题比较复杂。build tools 可以搞定这个问题。但是如果你代码存在反射和native的调用也不保证100%正确。<del>呵呵</del></li>
</ol>
<p>感觉这就是个坑啊。补丁方案又引入一些问题。但是插件化方案要求对现有代码有比较大的改动，代价太大，而且动态化加载框架意味着维护成本更高，会有更多潜在bug。所以先测试，遇到有问题的版本再解决。</p>
<h2 id="di-er-hui-he-sha-dexopt-failed">第二回合 啥？dexopt failed？</h2>
<p>呵呵，部分低端2.3机型(话说2.3版本的android机有高端机型么)安装失败！INSTALL_FAILED_DEXOPT。这个就是前面说的Issue <a href="https://code.google.com/p/android/issues/detail?id=22586">22586</a>问题。</p>
<p>apk是一个zip压缩包，dalvik每次加载apk都要从中解压出class.dex文件，加载过程还涉及到dex的classes需要的杂七杂八的依赖库的加载，真耗时间。于是Android决定优化一下这个问题，在app安装到手机之后，系统运行<a href="http://www.netmite.com/android/mydroid/dalvik/docs/dexopt.html">dexopt</a>程序对dex进行优化，将dex的依赖库文件和一些辅助数据打包成odex文件。存放在cache/dalvik_cache目录下。保存格式为apk路径 @ apk名 @ classes.dex。这样以空间换时间大大缩短读取/加载dex文件的过程。</p>
<p>那刚才那个bug是啥问题呢，原来dexopt程序的dalvik分配一块内存来统计你的app的dex里面的classes的信息，由于classes太多方法太多超过这个linearAlloc 的限制 。那减小dex的大小就可以咯。</p>
<p>gradle脚本如下：</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">android.applicationVariants.all {
    variant -&gt;
        dex.doFirst{
            dex-&gt;
            </span><span style="color:#b48ead;">if</span><span style="color:#c0c5ce;"> (dex.additionalParameters == </span><span style="color:#d08770;">null</span><span style="color:#c0c5ce;">) {
                dex.additionalParameters = []
            }
                dex.additionalParameters += &#39;</span><span style="color:#a3be8c;">--set-max-idx-number=48000</span><span style="color:#c0c5ce;">&#39;

       }
}
</span></code></pre>
<p>--set-max-idx-number=<value> 用于控制每一个dex的最大方法个数，写小一点可以产生好几个dex。
踩过更多坑的FB的工程师表示这个linearAlloc的限制不仅仅在安装时候的dexopt程序里<a href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-dalvik-patch-for-facebook-for-android/10151345597798920">7</a>，还在你的app的dalvik rumtime里。（很显然啊dvk vm的宿主进程fork自于同一个母体啊）。为了表示对这个坑的不满以及对Google的产品表示遗憾，FB工程师Read The Fucking Source Code找到了一个hack方案。这个linearAlloc的size定义在c层而且是一个全局变量，他们通过对结构体的size的计算成功覆盖了该值的内容，这里要特别感谢C语言的指针和内存的设计。C的世界里，You Are The King of This World。当然实际情况是大部分用户用这把利刃割伤了自己。。。<del>别问总悟君谁是世界上最好的语言。。。</del></p>
<p>为FB的工程师的机智和务实精神点赞！然而总悟君不愿意花那么多精力实现FB的hack方法。（dvk虚拟机c层代码在2.x  4.x 版本里有变更，找到那个内存地址太难，未必搞得定啊）我们有偷懒的解决方案，为了避免2.3机型runtime 的linearAlloclimit ,最好保持每一个dex体积&lt;4M ,刚才的的value&lt;=48000</p>
<p>好了 现在2.3的机器可以安装run起来了！</p>
<h2 id="di-san-hui-he-anrde-yi-si-jiu-shi-application-not-responding">第三回合 ANR的意思就是Application Not Responding</h2>
<p>问题又来了！这次不仅仅是2.3 的机型！还有一些中档配置的4.x系统的机型。问题现象是：第一次安装后，点击图标，1s，2s，3s... 程序没有任何反应就好像你没点图标一样。</p>
<p>5s过去。。。程序ANR! </p>
<p>其实不仅仅总悟君的App存在这个问题，其他很多App也存在首次安装运行后几秒都无任何响应的现象或者最后ANR了。唯一的例外是美团App，点击图标立马就出现界面。唉要不就算啦？反正就一次。。。不行，这可是产品给用户的第一印象啊太重要了，而且美团搞得定就说明这问题有解决方案。</p>
<p>ANR了是不是局限1描述的现象？？不过也不重要...因为Google只是告诉你说第二个dex太大了导致的。并没有进一步解释根本原因。怎么办？Google一发？搜索点击图标 然后ANR？怎么可能有解决方案嘛。ANR就意味着UI线程被阻塞了，老老实实查看log吧。</p>
<p>adb logcat -v time &gt; log.txt</p>
<p>于是发现 是 install dex + dexopt 时间太长！</p>
<p>梳理一下流程:</p>
<p>安装完app点击图标之后，系统木有发现对应的process，于是从该apk抽取classes.dex(主dex) 加载，触发 一次dexopt。 </p>
<p>App 的laucherActivity准备启动 ，触发Application启动， </p>
<p>Application的 onattach（）方法调用，这时候MultiDex.install（）调用，classes2.dex 被install，再次触发dexopt。</p>
<p>然后Applicaition onCreate（）执行。</p>
<p>然后 launcher Activity真的起来了。</p>
<p>这些必须在5s内完成不然就ANR给你看！</p>
<p>有点棘手。首先主dex是无论如何都绕不过加载和dexopt的。如果主dex比较小的话可以节省时间。主dex小就意味着后面的dex大啊，MultiDex.install（）是在主线程里做的，总时间又没有实质性改变。install（） 能不能放到线程里做啊？貌似不行。。。如果异步化，什么时候install完成都不知道。这时候如果进程需要seconday.dex里的classes信息不就悲剧？主dex越小这个错误几率就越大。要悲剧啊总悟君。</p>
<p>淡定，这次Google搜索MultiDex.install 。于是总悟君发现了<a href="http://tech.meituan.com/mt-android-auto-split-dex.html">美团多dex拆包方案</a>。 读完之后感觉看到胜利曙光。美团的主要思路是：精简主dex+异步加载secondary.dex 。对异步化执行速度的不确定性，他们的解决方案是重写Instrumentation execStartActivity 方法，hook跳转Activity的总入口做判断，如果当前secondary.dex 还没有加载完成，就弹一个loading Activity等待加载完成，如果已经加载完成那最好不过了。不错，RTFSC果然是王道。
可以试一试。</p>
<p>但是有几个问题需要解决：</p>
<p>1.分析主dex需要的classes这个脚本比较难写。。。Google文档说过这个问题比较复杂， 而且buildTools 不是已经帮我们搞定了吗？去瞄一下主dex的大小：8M 以及secondary.dex 3M 。 它是如何工作的？文档说dx的时候，先依据manifest里注册的组件生成一个 main-list，然后把这list里的classes所依赖的classes找出来，把他们打成classes.dex就是主dex。剩下的classes都放clsses2.dex(如果使用参数限制dex大小的话可能会有classe3.ex 等等） 。主dex至少含有main-list 的classes + 直接依赖classes ，使用mini-main-list参数可以仅仅包含刚才说的classes。</p>
<p>关于写分析脚本的思路是：直接使用mini-main-list参数获取build目录下的main-list文件，这样manifest声明的类和他们的直接依赖类搞定的了，那后者的直接依赖类怎么解？这些在dvk runtime也是必须的classes。一个思路是解析class文件获得该class的依赖类。还一个思路是自己使用Dexclassloader 加载dex，然后hook getClass()方法，调用一次就记录一个。都挺折腾的。</p>
<p>2.由于历史原因，总悟君在维护的App的manifest注册的组件的那些类，承载业务太多，依赖很多三方jar，导致直接依赖类非常多，而且短时间内无法梳理精简，没办法mini化主dex。</p>
<p>3.Application的启动入口太多。Appication初始化未必是由launcher Activity的启动触发，还有可能是因为Service ，Receiver ，ContentProvider 的启动。 靠拦截重写Instrumentation execStartActivity  解决不了问题。要为 Service ，Receiver ，ContentProvider 分别写基类，然后在oncreate()里判断是否要异步加载secondary.dex。如果需要，弹出Loading Acitvity？用户看到这个会感觉比较怪异。</p>
<p>结合自身App的实际情况来看美团的拆包方案虽然很美好然但是不能照搬啊。果然不能愉快地回家看动漫了。</p>
<h2 id="di-si-hui-he-huan-yi-chong-si-lu">第四回合 换一种思路</h2>
<p>考虑到刚才说的2，3原因，先不要急着动手写分析脚本。总悟君期望找到更好的方案。问题到现在变成了:既希望在Application的attachContext（）方法里同步加载secondary.dex，又不希望卡住UI线程。如果思路限制在线程异步化上，确实不可能实现。于是发现了<a href="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=207151651&amp;idx=1&amp;sn=9eab282711f4eb2b4daf2fbae5a5ca9a&amp;3rd=MzA3MDU4NTYzMw==&amp;scene=6#rd">微信开发团队的这篇文章</a>。该文章介绍了关于这一问题 FB/QQ/微信的解决方案。FB的解决思路特别赞，让Launcher Activity在另外一个进程启动！当然这个Launcher Activity就是用来load dex 的 ，load完成就启动Main Activity。</p>
<p>微信这篇文章给出了一个非常重要的观点：<strong>安装完成之后第一次启动时，是secondary.dex的dexopt花费了更多的时间</strong>。认识到这点非常重要，使得问题又转化为：在不阻塞UI线程的前提下，完成dexopt，以后都不需要再次dexopt，所以可以在UI线程install dex 了！文章最后给了一个对FB方案的改进版。</p>
<p>仔细读完感觉完全可行。</p>
<p>1.对现有代码改动量最小。 
2.该方案不关注Application被哪个组件启动。Activity ，Service ，Receiver ，ContentProvider 都满足。(有个问题要说明：如细心网友指出的那样，新安装还未启动但是收到Receiver的场景下，会导致Load界面出现。这个场景实际出现几率比较少，且仅出现一次。可以接受。)<br />
3.该方案不限制 Application ，Activity ，Service ，Receiver ，ContentProvider 继续新增业务。 
于是总悟君实现了这篇文章最后介绍的改进版的方法，稍微有一点点扩充。</p>
<p>流程图如下</p>
<p><img src="http://7xn3gz.com1.z0.glb.clouddn.com/image/github/zongwu233multiDex-process.png" alt="方案的流程图" />
上最终解决问题版的代码！</p>
<p>在Application里面(这里不要再继承自MultiApplication了，我们要手动加载Dex):</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">java.util.</span><span style="color:#ebcb8b;">Map</span><span style="color:#c0c5ce;">;
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">java.util.jar.</span><span style="color:#ebcb8b;">Attributes</span><span style="color:#c0c5ce;">;
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">java.util.jar.</span><span style="color:#ebcb8b;">JarFile</span><span style="color:#c0c5ce;">;
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">java.util.jar.</span><span style="color:#ebcb8b;">Manifest</span><span style="color:#c0c5ce;">;

</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">App </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">Application </span><span style="color:#eff1f5;">{
    </span><span style="color:#b48ead;">public static final </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">KEY_DEX2_SHA1 </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">dex2-SHA1-Digest</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">;
    @</span><span style="color:#bf616a;">Override
    </span><span style="color:#b48ead;">protected void </span><span style="color:#8fa1b3;">attachBaseContext</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Context </span><span style="color:#bf616a;">base</span><span style="color:#eff1f5;">) {
        </span><span style="color:#bf616a;">super </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">attachBaseContext</span><span style="color:#eff1f5;">(base);
        </span><span style="color:#ebcb8b;">LogUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">d</span><span style="color:#eff1f5;">( </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">loadDex</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">App attachBaseContext </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">!</span><span style="color:#bf616a;">quickStart</span><span style="color:#eff1f5;">() </span><span style="color:#c0c5ce;">&amp;&amp; </span><span style="color:#ebcb8b;">Build</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">VERSION</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">SDK_INT </span><span style="color:#c0c5ce;">&lt; </span><span style="color:#ebcb8b;">Build</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">VERSION_CODES</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">LOLLIPOP</span><span style="color:#eff1f5;">) {</span><span style="color:#65737e;">//&gt;=5.0的系统默认对dex进行oat优化
            </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">needWait</span><span style="color:#eff1f5;">(base)){
                </span><span style="color:#bf616a;">waitForDexopt</span><span style="color:#eff1f5;">(base);
            }
            </span><span style="color:#ebcb8b;">MultiDex</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">install </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this </span><span style="color:#eff1f5;">);
        } </span><span style="color:#b48ead;">else </span><span style="color:#eff1f5;">{
            </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;">;
        }
    }

    @</span><span style="color:#bf616a;">Override
    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">onCreate</span><span style="color:#eff1f5;">() {
        </span><span style="color:#bf616a;">super </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">onCreate</span><span style="color:#eff1f5;">();
        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">quickStart</span><span style="color:#eff1f5;">()) {
            </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;">;
        }
        ...
    }

    </span><span style="color:#b48ead;">public boolean </span><span style="color:#8fa1b3;">quickStart</span><span style="color:#eff1f5;">() {
        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">StringUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">contains</span><span style="color:#eff1f5;">( </span><span style="color:#bf616a;">getCurProcessName</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">), </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">:mini</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">)) {
            </span><span style="color:#ebcb8b;">LogUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">d</span><span style="color:#eff1f5;">( </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">loadDex</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">:mini start!</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">;
        }
        </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">false </span><span style="color:#eff1f5;">;
    }
    </span><span style="color:#65737e;">//neead wait for dexopt ?
    </span><span style="color:#b48ead;">private boolean </span><span style="color:#8fa1b3;">needWait</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Context </span><span style="color:#bf616a;">context</span><span style="color:#eff1f5;">){
        </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> flag </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">get2thDexSHA1</span><span style="color:#eff1f5;">(context);
        </span><span style="color:#ebcb8b;">LogUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">d</span><span style="color:#eff1f5;">( </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">loadDex</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">dex2-sha1 </span><span style="color:#c0c5ce;">&quot;+</span><span style="color:#eff1f5;">flag);
        </span><span style="color:#ebcb8b;">SharedPreferences</span><span style="color:#eff1f5;"> sp </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> context.</span><span style="color:#bf616a;">getSharedPreferences</span><span style="color:#eff1f5;">(
                </span><span style="color:#ebcb8b;">PackageUtil</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">getPackageInfo</span><span style="color:#eff1f5;">(context). versionName, </span><span style="color:#d08770;">MODE_MULTI_PROCESS</span><span style="color:#eff1f5;">);
        </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> saveValue </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> sp.</span><span style="color:#bf616a;">getString</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">KEY_DEX2_SHA1</span><span style="color:#eff1f5;">, </span><span style="color:#c0c5ce;">&quot;&quot;</span><span style="color:#eff1f5;">);
        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">!</span><span style="color:#ebcb8b;">StringUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">equals</span><span style="color:#eff1f5;">(flag,saveValue);
    }
    </span><span style="color:#65737e;">/**
     * Get classes.dex file signature
     * </span><span style="color:#b48ead;">@param </span><span style="color:#bf616a;">context
     </span><span style="color:#65737e;">* </span><span style="color:#b48ead;">@return
     </span><span style="color:#65737e;">*/
    private String get2thDexSHA1(Context context) {
        ApplicationInfo ai = context.getApplicationInfo();
        String source = ai.sourceDir;
        try {
            JarFile jar = new JarFile(source);
            Manifest mf = jar.getManifest();
            Map&lt;</span><span style="color:#bf616a;">String, </span><span style="color:#d08770;">Attributes</span><span style="color:#65737e;">&gt; map = mf.getEntries();
            Attributes a = map.get(&quot;classes2.dex&quot;);
            return a.getValue(&quot;SHA1-Digest&quot;);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null ;
    }
    // optDex finish 
    public void installFinish(Context context){
        SharedPreferences sp = context.getSharedPreferences(
                PackageUtil.getPackageInfo(context).versionName, MODE_MULTI_PROCESS);
        sp.edit().putString(KEY_DEX2_SHA1,get2thDexSHA1(context)).commit();
    }


    public static String getCurProcessName(Context context) {
        try {
            int pid = android.os.Process.myPid();
            ActivityManager mActivityManager = (ActivityManager) context
                    .getSystemService(Context. ACTIVITY_SERVICE);
            for (ActivityManager.RunningAppProcessInfo appProcess : mActivityManager
                    .getRunningAppProcesses()) {
                if (appProcess.pid == pid) {
                    return appProcess. processName;
                }
            }
        } catch (Exception e) {
            // ignore
        }
        return null ;
    }
    public void waitForDexopt(Context base) {
        Intent intent = new Intent();
        ComponentName componentName = new
                ComponentName( &quot;com.zongwu&quot;, LoadResActivity.class.getName());
        intent.setComponent(componentName);
        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        base.startActivity(intent);
        long startWait = System.currentTimeMillis ();
        long waitTime = 10 * 1000 ;
        if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB_MR1 ) {
            waitTime = 20 * 1000 ;//实测发现某些场景下有些2.3版本有可能10s都不能完成optdex
        }
        while (needWait(base)) {
            try {
                long nowWait = System.currentTimeMillis() - startWait;
                LogUtils.d(&quot;loadDex&quot; , &quot;wait ms :&quot; + nowWait);
                if (nowWait &gt;= waitTime) {
                    return;
                }
                Thread.sleep(200 );
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

</span></code></pre>
<p>PackageUtil的方法</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;"> public static PackageInfo getPackageInfo(Context context){
        PackageManager pm = context.getPackageManager();
        try {
            return pm.getPackageInfo(context.getPackageName(), 0);
        } catch (PackageManager.NameNotFoundException e) {
            LogUtils.e(e.getLocalizedMessage());
        }
        return  new PackageInfo();
    }
</span></code></pre>
<p>这里使用了classes(N).dex的方式保存了后面的dex而不是像微信目前的做法放到assest文件夹。前面有说到ART模式会将多个dex优化合并成oat文件。如果放置在asset里面就没有这个好处了。</p>
<p>Launcher Activity 依然是原来的代码里的WelcomeActivity。</p>
<p>在Application启动的时候会检测dexopt是否已经完成过，（检测方式是查看sp文件是否有dex文件的SHA1-Digest记录，这里要两个进程读取该sp,读取模式是MODE_MULTI_PROCESS）。如果没有就启动LoadDexActivity(属于：mini进程) 。否则就直接install dex ！对，直接install。通过日志发现，已经dexopt的dex文件再次install的时候 只耗费几十毫秒。</p>
<p>LoadDexActivity 的逻辑比较简单，启动AsyncTask 来install dex 这时候会触发dexopt 。</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">LoadResActivity </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">Activity </span><span style="color:#eff1f5;">{
    @</span><span style="color:#bf616a;">Override
    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">onCreate</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Bundle </span><span style="color:#bf616a;">savedInstanceState</span><span style="color:#eff1f5;">) {
        </span><span style="color:#bf616a;">requestWindowFeature</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Window</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">FEATURE_NO_TITLE</span><span style="color:#eff1f5;">);
        </span><span style="color:#bf616a;">super </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">onCreate</span><span style="color:#eff1f5;">(savedInstanceState);
        </span><span style="color:#bf616a;">getWindow</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">setFlags</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">WindowManager</span><span style="color:#eff1f5;">.</span><span style="color:#ebcb8b;">LayoutParams</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">FLAG_FULLSCREEN </span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">WindowManager</span><span style="color:#eff1f5;">.</span><span style="color:#ebcb8b;">LayoutParams</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">FLAG_FULLSCREEN </span><span style="color:#eff1f5;">);
        </span><span style="color:#bf616a;">overridePendingTransition</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">R</span><span style="color:#eff1f5;">.anim.null_anim, </span><span style="color:#ebcb8b;">R</span><span style="color:#eff1f5;">.anim.null_anim);
        </span><span style="color:#bf616a;">setContentView</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">R</span><span style="color:#eff1f5;">.layout.layout_load);      
        </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">LoadDexTask</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">execute</span><span style="color:#eff1f5;">();
    }
    </span><span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">LoadDexTask </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">AsyncTask </span><span style="color:#eff1f5;">{
        @</span><span style="color:#bf616a;">Override
        </span><span style="color:#b48ead;">protected </span><span style="color:#ebcb8b;">Object </span><span style="color:#8fa1b3;">doInBackground</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Object</span><span style="color:#b48ead;">[] </span><span style="color:#bf616a;">params</span><span style="color:#eff1f5;">) {
            </span><span style="color:#b48ead;">try </span><span style="color:#eff1f5;">{
                </span><span style="color:#ebcb8b;">MultiDex</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">install</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">getApplication</span><span style="color:#eff1f5;">());
                </span><span style="color:#ebcb8b;">LogUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">d</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">loadDex</span><span style="color:#c0c5ce;">&quot; </span><span style="color:#eff1f5;">, </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">install finish</span><span style="color:#c0c5ce;">&quot; </span><span style="color:#eff1f5;">);
                ((</span><span style="color:#ebcb8b;">App</span><span style="color:#eff1f5;">) </span><span style="color:#bf616a;">getApplication</span><span style="color:#eff1f5;">()).</span><span style="color:#bf616a;">installFinish</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">getApplication</span><span style="color:#eff1f5;">());
            } </span><span style="color:#b48ead;">catch </span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Exception </span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">) {
                </span><span style="color:#ebcb8b;">LogUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">e</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">loadDex</span><span style="color:#c0c5ce;">&quot; </span><span style="color:#eff1f5;">, e.</span><span style="color:#bf616a;">getLocalizedMessage</span><span style="color:#eff1f5;">());
            }
            </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">null</span><span style="color:#eff1f5;">;
        }
        @</span><span style="color:#bf616a;">Override
        </span><span style="color:#b48ead;">protected void </span><span style="color:#8fa1b3;">onPostExecute</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Object </span><span style="color:#bf616a;">o</span><span style="color:#eff1f5;">) {
            </span><span style="color:#ebcb8b;">LogUtils</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">d</span><span style="color:#eff1f5;">( </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">loadDex</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">get install finish</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
            </span><span style="color:#bf616a;">finish</span><span style="color:#eff1f5;">();
            </span><span style="color:#ebcb8b;">System</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">exit</span><span style="color:#eff1f5;">( </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">);
        }
    }
    @</span><span style="color:#bf616a;">Override
    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">onBackPressed</span><span style="color:#eff1f5;">() {
        </span><span style="color:#65737e;">//cannot backpress
    </span><span style="color:#eff1f5;">}

</span></code></pre>
<p>Manifest.xml 里面 <br/></p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&lt;activity
    android:name= &quot;com.zongwu.LoadResActivity&quot;
    android:launchMode= &quot;singleTask&quot;
    android:process= &quot;:mini&quot;
    android:alwaysRetainTaskState= &quot;false&quot;
    android:excludeFromRecents= &quot;true&quot;
    android:screenOrientation= &quot;portrait&quot; /&gt;

&lt;activity
    android:name= &quot;com.zongwu.WelcomeActivity&quot;
    android:launchMode= &quot;singleTop&quot;
    android:screenOrientation= &quot;portrait&quot;&gt;
    &lt;intent-filter &gt;
        &lt;action android:name=&quot;android.intent.action.MAIN&quot;/&gt;
        &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot;/&gt;
    &lt;/intent-filter &gt;
&lt;/activity&gt;
</span></code></pre>
<p>替换Activity默认的出现动画 R.anim.null_anim 文件的定义：</p>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">&lt;set xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;
    &lt;alpha
        android:fromAlpha=&quot;1.0&quot;
        android:toAlpha=&quot;1.0&quot;
        android:duration=&quot;550&quot;/&gt;
&lt;/set&gt;
</span></code></pre>
<p>如<a href="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=207151651&amp;idx=1&amp;sn=9eab282711f4eb2b4daf2fbae5a5ca9a&amp;3rd=MzA3MDU4NTYzMw==&amp;scene=6#rd">微信开发团队的这篇文章</a>所说，application启动了LoadDexActivity之后，自身不再是前台进程所以怎么hold 线程都不会ANR。</p>
<p>系统何时会对apk进行dexopt总悟君其实并没有十分明白。通过查看安装运行的日志发现，安装的时候packageManagerService会对classes.dex 进行dexopt 。在调用MultiDex.install（）加载 secondary.dex的时候，也会进行一次dexopt 。 这背后的流程到底是怎样的？dexopt是如何在另外一个进程执行的？如果是另外一个进程执行为何会阻塞主app的UI进程？ 官方文档并没有详细介绍这个，那就RTFSC一探究竟吧.</p>
<p>源代码跟踪比较长，移步到<a href="/dexopt-process">这里</a>看吧。</p>
<h2 id="zui-zhong-zhang-sui-sui-nian">最终章碎碎念</h2>
<ul>
<li>MultiDex的问题难点在：要持续解决好几个bug才能最终解决问题。进一步的，想要仔细分辨且解决这些bug，就必须持续探索一些关联性的概念和原理</li>
<li>耗费了这么多时间来解决了Android系统的缺陷是不是有点略伤心。这不应该是Google给出一个比较彻底的解决方案吗？</li>
<li>FB的工程师们脑洞好大。思考问题的方式很值得借鉴。</li>
<li>微信团队的文章提到逆向了不少App。哈！总悟君感觉增长知识拓宽视野的新技能<strong>加强</strong>。</li>
<li><strong>RTFSC是王道</strong>。</li>
<li>在查看log的过程中发现一个比较有趣的现象。在App的secondary.dex加载之前居然先加载了某~~数字~~公司的dex！(手机没有root但是安装了xx手机助手)再加上之前看到的错误堆栈里Android framework的调用堆栈之间也赫然有他们的代码。总悟君恶意猜测该app利用了某种手段进行了提权，hook了系统框架代码，将自己的代码注入到了每一个应用app的进程里。嗯。。。有趣。。。</li>
<li>嗯今晚已经没有时间看动漫了。。。</li>
</ul>

    </div>

    
    

    <div class="post-footer">
        
            
            
                <div class="post-nav">
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;dexopt-process&#x2F;">dexopt的源码跟踪 ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;blog.zongwu233.com&#x2F;even.js" ></script>
      
      <!--  add cnzz trace code  -->
      
          <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");document.write(unescape("%3Cspan style='display:none;' id='cnzz_stat_icon_1273937782'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s22.cnzz.com/z_stat.php%3Fid%3D1273937782' type='text/javascript'%3E%3C/script%3E"));</script>
      
    </body>

</html>
